# src/pipeline.py
import os
from typing import Dict, Any

from swe_agent.analyze import run_ruff
from swe_agent.code_coverage import run_pytest_coverage
from swe_agent.coverage_parser import parse_coverage_xml
from swe_agent.test_suggester import suggest_tests_for_file
from swe_agent.dependencies import (
    find_outdated_dependencies,
    find_vulnerable_dependencies,
)
from swe_agent.test_generation_pipeline import  generate_test_file
from swe_agent.pr_creator import create_pr
from swe_agent.report_md import generate_markdown_report,write_markdown_report
from swe_agent.report_sarif import write_sarif,generate_sarif

def analyze_repo(repo_path: str, reports_dir: str, generate_tests=False) -> Dict[str, Any]:
    os.makedirs(reports_dir, exist_ok=True)

    report: Dict[str, Any] = {
        "repo_path": repo_path,
        "ruff": {},
        "coverage": {},
        "missing_tests": [],
    }

    # 1) Ruff
    ruff_res = run_ruff(repo_path)
    report["ruff"] = {
        "returncode": ruff_res.returncode,
        "stdout": ruff_res.stdout,
        "stderr": ruff_res.stderr,
    }

    # 2) Pytest + Coverage
    cov_res = run_pytest_coverage(repo_path, reports_dir)
    report["coverage"]["pytest"] = {
        "returncode": cov_res.returncode,
        "stdout": cov_res.stdout,
        "stderr": cov_res.stderr,
    }

    # 3) Parse coverage (only if xml exists)
    if os.path.exists(cov_res.coverage_xml_path):
        files = parse_coverage_xml(cov_res.coverage_xml_path)
        report["coverage"]["files"] = [
            f.__dict__ for f in files
        ]

        # 4) Suggest tests for low coverage files
        for f in files:
            if f.coverage_percent < 80:
                file_path = os.path.join(repo_path, f.filename)
                if os.path.exists(file_path):
                    suggestions = suggest_tests_for_file(file_path)
                    report["missing_tests"].extend(
                        [s.__dict__ for s in suggestions]
                    )
                    if generate_tests:
                        # only for files with low coverage
                        test_dir = os.path.join(reports_dir, "tests")
                        generate_test_file(file_path, suggestions, test_dir)

        url = create_pr(
            repo_path=repo_path,
            repo_full_name="vsstech/swe_agent_repo2",
            branch_name="agent/add-missing-tests",
            pr_title="Add missing unit tests (auto-generated)",
            pr_body="""
        This PR was generated by the SWE Agent.

        Includes:
        - Unit tests for uncovered functions
        - No production code changes

        Please review before merging.
        """,
        )

        print("PR created:", url)
        # 5) Dependency analysis
        report["dependencies"] = {
            "outdated": [d.__dict__ for d in find_outdated_dependencies(repo_path)],
            "vulnerable": [v.__dict__ for v in find_vulnerable_dependencies(repo_path)],
        }

        md = generate_markdown_report(report)
        write_markdown_report(md, os.path.join(reports_dir, "report.md"))

        sarif = generate_sarif(report)
        write_sarif(sarif, os.path.join(reports_dir, "report.sarif"))

    return report
